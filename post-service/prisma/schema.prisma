generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Comment {
  id              String           @id
  postId          String
  userId          String
  content         String
  parentCommentId String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @default(now())
  deletedAt       DateTime?
  editedAt        DateTime?
  version         Int              @default(1)
  likesCount      Int              @default(0)
  Comment         Comment?         @relation("CommentToComment", fields: [parentCommentId], references: [id])
  other_Comment   Comment[]        @relation("CommentToComment")
  posts           posts            @relation(fields: [postId], references: [id], onDelete: Cascade)
  CommentMention  CommentMention[]
  Reaction        Reaction[]
  Report          Report[]

  @@index([createdAt])
  @@index([deletedAt])
  @@index([parentCommentId])
  @@index([postId])
  @@index([userId])
}

model CommentMention {
  id              String   @id
  commentId       String
  mentionedUserId String
  actorId         String
  createdAt       DateTime @default(now())
  Comment         Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([commentId, mentionedUserId])
  @@index([actorId])
  @@index([commentId])
  @@index([mentionedUserId])
}

model IdempotencyKey {
  id          String            @id
  key         String            @unique
  userId      String
  route       String
  requestHash String?
  response    Json?
  status      IdempotencyStatus @default(IN_PROGRESS)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @default(now())
  method      HttpMethod

  @@index([key])
  @@index([userId])
}

model Media {
  id        String    @id
  postId    String?
  type      MediaType
  url       String
  createdAt DateTime  @default(now())
  posts     posts?    @relation(fields: [postId], references: [id])
}

model OutboxEvent {
  id              String              @id
  aggregateId     String?
  key             String?
  payload         Json
  status          OutboxStatus        @default(PENDING)
  attempts        Int                 @default(0)
  lastAttemptedAt DateTime?
  createdAt       DateTime            @default(now())
  publishedAt     DateTime?
  aggregateType   OutboxAggregateType
  type            OutboxEventType
  topic           String

  @@index([aggregateType, aggregateId])
  @@index([createdAt])
  @@index([status])
}

model Poll {
  id        String   @id
  postId    String   @unique
  question  String
  options   Json[]
  duration  Int
  createdAt DateTime @default(now())
  posts     posts    @relation(fields: [postId], references: [id], onDelete: Cascade)
}

model PostMention {
  id              String   @id
  postId          String
  mentionedUserId String
  actorId         String
  createdAt       DateTime @default(now())
  posts           posts    @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([postId, mentionedUserId])
  @@index([actorId])
  @@index([mentionedUserId])
  @@index([postId])
}

model PostShareLink {
  id             String    @id
  postId         String
  shortId        String    @unique
  shareToken     String?   @unique
  tokenExpiresAt DateTime?
  createdById    String
  clickCount     Int       @default(0)
  createdAt      DateTime  @default(now())
  posts          posts     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([postId])
  @@index([shareToken])
  @@index([shortId])
}

model PostVersion {
  id            String   @id
  postId        String
  versionNumber Int
  content       String
  attachmentIds String[]
  editedAt      DateTime @default(now())
  editedById    String
  posts         posts    @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([postId, versionNumber])
  @@index([editedAt])
  @@index([postId])
  @@index([versionNumber])
}

model Reaction {
  id         String             @id
  postId     String?
  userId     String
  type       ReactionType       @default(LIKE)
  createdAt  DateTime           @default(now())
  deletedAt  DateTime?
  commentId  String?
  targetType ReactionTargetType
  version    Int                @default(1)
  Comment    Comment?           @relation(fields: [commentId], references: [id], onDelete: Cascade)
  posts      posts?             @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId, type])
  @@unique([postId, userId, type])
  @@index([commentId])
  @@index([createdAt])
  @@index([deletedAt])
  @@index([postId])
  @@index([userId])
}

model Report {
  id           String           @id
  postId       String?
  createdAt    DateTime         @default(now())
  commentId    String?
  metadata     Json?
  reporterId   String
  resolvedAt   DateTime?
  status       ReportStatus     @default(PENDING)
  targetId     String
  targetType   ReportTargetType
  updatedAt    DateTime         @default(now())
  reason       ReportReason
  description  String?
  resolution   String?
  reviewedAt   DateTime?
  reviewedById String?
  severity     ReportSeverity   @default(LOW)
  Comment      Comment?         @relation(fields: [commentId], references: [id], onDelete: Cascade)
  posts        posts?           @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([reporterId, targetType, targetId])
  @@index([createdAt])
  @@index([reporterId])
  @@index([severity])
  @@index([status])
  @@index([targetType, targetId])
}

model SavedPost {
  userId    String
  postId    String
  createdAt DateTime @default(now())
  posts     posts    @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@id([userId, postId])
  @@index([createdAt])
  @@index([postId])
  @@index([userId])
}

model Share {
  id             String     @id
  postId         String
  userId         String
  targetType     TargetType @default(USER)
  targetId       String?
  createdAt      DateTime   @default(now())
  caption        String?
  shareType      ShareType  @default(RESHARE)
  deletedAt      DateTime?
  sharedToUserId String?
  updatedAt      DateTime   @default(now())
  visibility     Visibility @default(PUBLIC)
  posts          posts      @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([postId])
  @@index([shareType])
  @@index([targetId])
  @@index([userId])
}

model UserFeed {
  userId    String
  postId    String
  
  // ✅ NEW: Relevance scoring for personalized feed ranking
  relevanceScore Float    @default(0.0) // 0.0 - 1.0, higher = more relevant
  scoreUpdatedAt DateTime @default(now()) @updatedAt
  
  // ✅ NEW: Feed metadata for UX
  isRead       Boolean   @default(false)
  readAt       DateTime?
  
  // ✅ NEW: Ranking metadata for efficient pagination
  rankPosition Int?      // Position in user's feed (updated on score changes)
  
  createdAt    DateTime  @default(now())
  posts     posts    @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@id([userId, postId])
  // ✅ Composite index for efficient feed queries (ranked by relevance)
  @@index([userId, relevanceScore(sort: Desc), createdAt(sort: Desc)])
  @@index([userId, isRead])
  @@index([scoreUpdatedAt])
  @@map("user_feeds")
}

model posts {
  id              String          @id @default(cuid())
  content         String
  userId          String
  createdAt       DateTime        @default(now())
  commentsCount   Int             @default(0)
  deletedAt       DateTime?
  impressions     Int             @default(0)
  likesCount      Int             @default(0)
  pinned          Boolean         @default(false)
  pinnedAt        DateTime?
  reportsCount    Int             @default(0)
  sharesCount     Int             @default(0)
  tags            String[]        @default([])
  updatedAt       DateTime        @default(now())
  visibility      Visibility      @default(PUBLIC)
  commentControl  CommentControl  @default(ANYONE)
  currentVersion  Int             @default(1)
  isEditing       Boolean         @default(false)
  editCount       Int             @default(0)
  lastEditedAt    DateTime?
  isHidden        Boolean         @default(false)
  hiddenAt        DateTime?
  hiddenReason    String?
  sharingDisabled Boolean         @default(false)
  canonicalUrl    String?
  Comment         Comment[]
  Media           Media[]
  Poll            Poll?
  PostMention     PostMention[]
  PostShareLink   PostShareLink[]
  PostVersion     PostVersion[]
  Reaction        Reaction[]
  Report          Report[]
  SavedPost       SavedPost[]
  Share           Share[]
  UserFeed        UserFeed[]

  @@index([commentsCount])
  @@index([createdAt])
  @@index([impressions])
  @@index([isHidden])
  @@index([likesCount])
  @@index([tags])
  @@index([userId])
}

enum CommentControl {
  ANYONE
  CONNECTIONS
  NONE
}

enum HttpMethod {
  GET
  POST
  PUT
  PATCH
  DELETE
}

enum IdempotencyStatus {
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum MediaType {
  IMAGE
  VIDEO
}

enum OutboxAggregateType {
  POST
  COMMENT
  REACTION
  SHARE
  REPORT
  MENTION
}

enum OutboxEventType {
  POST_LIKE_CREATED
  POST_LIKE_REMOVED
  POST_COMMENT_CREATED
  POST_COMMENT_EDITED
  POST_COMMENT_DELETED
  COMMENT_LIKE_CREATED
  COMMENT_LIKE_REMOVED
  SHARE_CREATED
  POST_REPORT_CREATED
  POST_MENTION_IN_POST_CREATED
  POST_MENTION_IN_COMMENT_CREATED
  POST_SENT
  POST_CREATED  // ✅ NEW: For fan-out and notifications
  POST_UPDATED  // ✅ NEW: For feed updates on post edits
}

enum OutboxStatus {
  PENDING
  SENDING
  SENT
  FAILED
}

enum PostType {
  TEXT
  ARTICLE
  POLL
}

enum ReactionTargetType {
  POST
  COMMENT
  REACTION_POST
  REACTION_COMMENT
}

enum ReactionType {
  LIKE
  CELEBRATE
  SUPPORT
  LOVE
  INSIGHTFUL
  CURIOUS
}

enum ReportReason {
  SPAM
  INAPPROPRIATE
  HARASSMENT
  HATE_SPEECH
  VIOLENCE
  SELF_HARM
  OTHER
  FALSE_INFORMATION
  COPYRIGHT_VIOLATION
}

enum ReportSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ReportStatus {
  OPEN
  INVESTIGATING
  CLOSED
  PENDING
  RESOLVED_APPROVED
  RESOLVED_REMOVED
  RESOLVED_IGNORED
}

enum ReportTargetType {
  POST
  COMMENT
}

enum ShareType {
  RESHARE
  QUOTE
  TO_FEED
  PRIVATE_MESSAGE
  TO_CONVERSATION
}

enum TargetType {
  USER
  GROUP
}

enum Visibility {
  PUBLIC
  VISIBILITY_CONNECTIONS
}
